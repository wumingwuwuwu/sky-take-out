<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }

        .message-area {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .message-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            word-wrap: break-word;
        }

        .message-sent {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
            text-align: right;
        }

        .message-received {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
        }

        .message-system {
            background-color: #fff3cd;
            color: #856404;
            text-align: center;
            font-style: italic;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .info-panel h3 {
            margin-top: 0;
            color: #1976d2;
        }

        .info-panel ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-panel li {
            margin-bottom: 5px;
        }

        .timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸš€ WebSocket æ¼”ç¤ºæ§åˆ¶å°</h1>

    <div class="info-panel">
        <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
        <ul>
            <li>åç«¯WebSocketæœåŠ¡è¿è¡Œåœ¨ç«¯å£: <strong>æœ¬åœ°çš„åç«¯ç«¯å£</strong></li>
            <li>WebSocketç«¯ç‚¹: <strong>ws://localhost:æœ¬åœ°çš„åç«¯ç«¯å£}/ws/{clientId}</strong></li>
            <li>æ”¯æŒç¾¤å‘æ¶ˆæ¯åŠŸèƒ½</li>
            <li>è‡ªåŠ¨é‡è¿æœºåˆ¶</li>
        </ul>
    </div>

    <div class="status-panel">
        <strong>è¿æ¥çŠ¶æ€:</strong>
        <span id="status">
                <span class="status-indicator status-disconnected"></span>
                <span id="status-text">æœªè¿æ¥</span>
            </span>
        <span class="timestamp" id="status-time"></span>
    </div>

    <div class="message-area" id="messageArea">
        <div class="message-system message-item">æ¬¢è¿ä½¿ç”¨WebSocketæ¼”ç¤ºå·¥å…·ï¼</div>
    </div>

    <div class="input-group">
        <input type="text" id="messageInput" class="message-input" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯..."
               onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
    </div>

    <div class="button-group">
        <button class="btn btn-success" onclick="connectWebSocket()">è¿æ¥æœåŠ¡å™¨</button>
        <button class="btn btn-danger" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
        <button class="btn btn-warning" onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
        <button class="btn btn-primary" onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
    </div>
</div>

<script>
    let websocket = null;
    let clientId = 'demo-client-' + Math.random().toString(36).substr(2, 9);
    let reconnectInterval = null;
    let isManualDisconnect = false;

    // è·å–DOMå…ƒç´ 
    const messageArea = document.getElementById('messageArea');
    const messageInput = document.getElementById('messageInput');
    const statusText = document.getElementById('status-text');
    const statusIndicator = document.querySelector('.status-indicator');
    const statusTime = document.getElementById('status-time');

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(status, colorClass) {
        statusText.textContent = status;
        statusIndicator.className = `status-indicator ${colorClass}`;
        statusTime.textContent = new Date().toLocaleTimeString();
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°æ˜¾ç¤ºåŒºåŸŸ
    function addMessage(message, type = 'system') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-item message-${type}`;

        const timestamp = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `
                ${message}
                <span class="timestamp">${timestamp}</span>
            `;

        messageArea.appendChild(messageDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // è¿æ¥WebSocket
    function connectWebSocket() {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            addMessage('å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨', 'system');
            return;
        }

        isManualDisconnect = false;
        updateStatus('è¿æ¥ä¸­...', 'status-connecting');

        try {
            const wsUrl = `ws://localhost:8085/ws/${clientId}`;
            addMessage(`æ­£åœ¨è¿æ¥åˆ°: ${wsUrl}`, 'system');

            websocket = new WebSocket(wsUrl);

            websocket.onopen = function(event) {
                updateStatus('å·²è¿æ¥', 'status-connected');
                addMessage('âœ… WebSocketè¿æ¥æˆåŠŸå»ºç«‹ï¼', 'system');
                addMessage(`å®¢æˆ·ç«¯ID: ${clientId}`, 'system');

                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            websocket.onmessage = function(event) {
                addMessage(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'received');
            };

            websocket.onerror = function(error) {
                updateStatus('è¿æ¥é”™è¯¯', 'status-disconnected');
                addMessage('âŒ WebSocketè¿æ¥å‘ç”Ÿé”™è¯¯', 'system');
                console.error('WebSocket error:', error);
            };

            websocket.onclose = function(event) {
                updateStatus('å·²æ–­å¼€', 'status-disconnected');
                addMessage(`ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­ (ä»£ç : ${event.code}, åŸå› : ${event.reason})`, 'system');

                if (!isManualDisconnect && !reconnectInterval) {
                    addMessage('ğŸ”„ 5ç§’åå°è¯•é‡æ–°è¿æ¥...', 'system');
                    reconnectInterval = setTimeout(() => {
                        if (!isManualDisconnect) {
                            connectWebSocket();
                        }
                    }, 5000);
                }
            };

        } catch (error) {
            updateStatus('è¿æ¥å¤±è´¥', 'status-disconnected');
            addMessage(`âŒ åˆ›å»ºWebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'system');
        }
    }

    // æ–­å¼€WebSocketè¿æ¥
    function disconnectWebSocket() {
        isManualDisconnect = true;

        if (reconnectInterval) {
            clearTimeout(reconnectInterval);
            reconnectInterval = null;
        }

        if (websocket) {
            if (websocket.readyState === WebSocket.OPEN) {
                websocket.close(1000, 'ç”¨æˆ·ä¸»åŠ¨æ–­å¼€è¿æ¥');
                addMessage('ğŸ‘‹ æ­£åœ¨æ–­å¼€WebSocketè¿æ¥...', 'system');
            } else {
                addMessage('WebSocketæœªè¿æ¥', 'system');
            }
        } else {
            addMessage('WebSocketå®ä¾‹ä¸å­˜åœ¨', 'system');
        }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
        const message = messageInput.value.trim();

        if (!message) {
            addMessage('âš ï¸ è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯', 'system');
            return;
        }

        if (!websocket || websocket.readyState !== WebSocket.OPEN) {
            addMessage('âŒ WebSocketæœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥æœåŠ¡å™¨', 'system');
            return;
        }

        try {
            websocket.send(message);
            addMessage(`ğŸ“¤ å‘é€æ¶ˆæ¯: ${message}`, 'sent');
            messageInput.value = '';
            messageInput.focus();
        } catch (error) {
            addMessage(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'system');
        }
    }

    // å‘é€æµ‹è¯•æ¶ˆæ¯
    function sendTestMessage() {
        const testMessages = [
            'Hello WebSocket!',
            'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
            'WebSocketè¿æ¥æµ‹è¯•',
            'æœåŠ¡å™¨ç¾¤å‘åŠŸèƒ½æµ‹è¯•',
            `å®¢æˆ·ç«¯ID: ${clientId}`
        ];

        const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
        messageInput.value = randomMessage;
        sendMessage();
    }

    // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
    function clearMessages() {
        messageArea.innerHTML = '<div class="message-system message-item">æ¶ˆæ¯å·²æ¸…ç©º</div>';
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿æ¥
    window.addEventListener('load', function() {
        addMessage('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿æ¥WebSocketæœåŠ¡å™¨...', 'system');
        // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨è¿æ¥
        setTimeout(connectWebSocket, 1000);
    });

    // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
    window.addEventListener('beforeunload', function() {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            isManualDisconnect = true;
            websocket.close(1000, 'é¡µé¢å¸è½½');
        }
    });

    // è®¾ç½®æ¶ˆæ¯è¾“å…¥æ¡†ç„¦ç‚¹
    messageInput.focus();
</script>
</body>
</html>
